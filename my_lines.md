mkdir final_project 
cd final_project

# Installing bcftools from conda to filter out accessions from vcf file
module load python/3.6-conda5.2
source activate ipy-env
conda create -n bcftools-env bcftools
source activate bcftools-env

mkdir my_lines
cd my_lines


# Download the VCF file containing SNP data (over 15,000 accessions)...3.6gigabyte
wget https://soybase.org/snps/soysnp50k_wm82.a2_41317.vcf.gz

# Write file with selections
nano lines.txt
## write following in script
PI157487A
PI175189
PI189867
PI243533
PI273483E
PI295947
PI306702C
PI323566
PI340011
PI358321C
PI391581B
PI398473
PI399020
PI408319A
PI408336
PI417394
PI423823
PI424605B
PI437388
PI438025
PI458022
PI458061B
PI458072B
PI458175A
PI458175C
PI458244A
PI458525
PI464915B
PI507132B
PI508296E
PI518291C
PI548227
PI548439
PI553048
PI567121B
PI567404F
PI567491B
PI567602B
PI567767A
PI567767D
PI578307B
PI578316A
PI587697
PI587998D
PI594608A
PI594608B
PI602447
PI603337B
PI603444B
PI603444D
PI603571A
PI603571C
PI603915A
PI605743B
PI613559D
PI632663B
PI175197
PI253653A
PI283327
PI306702B
PI358318A
PI358318B
PI398262
PI398368
PI398902
PI398949
PI398955
PI404191
PI407923
PI408076B
PI408139
PI416871
PI417093
PI417245
PI423705
PI424145
PI424164B
PI424560
PI437882A
PI458236A
PI464910
PI486355
PI504486
PI506826
PI511866
PI567070C
PI567414
PI567611
PI567629B
PI567646A
PI567681
PI567759
PI578307A
PI587997B
PI588029
PI594170A
PI603337A
PI603445A
PI628825
PI319530
PI323561
PI398726
PI398972
PI407861A
PI424214C
PI438507C
PI445683
PI445796
PI458040
PI464901
PI506728
PI506787
PI507437
PI507686A
PI507686B
PI512322C
PI518291B
PI548568
PI549030B
PI556949
PI567352A
PI567352B
PI567432B
PI567602A
PI567767C
PI578318B
PI587998A
PI587998C
PI592907A
PI592912A
PI597394
PI603412A
PI603424B
PI603424C
PI603424D
PI603601
PI603742B
PI603742D
PI603915B
PI605743A
PI605825B
PI613559E
PI632663A
PI157414
PI157450
PI157482
PI398194
PI398217
PI398229
PI398341
PI398370
PI398576
PI398714
PI398745
PI398870
PI398937
PI398951
PI399002
PI399003
PI399017
PI399038
PI399057
PI399107
PI407794
PI407833C
PI407876
PI407941A
PI408015
PI408081
PI408134A
PI408185
PI408272B
PI423817
PI423840
PI423844
PI424214A
PI424273A
PI424325
PI458048
PI458091
PI458185
PI458203B
PI458226
PI506716
PI507528
PI509105
PI532466B
PI603159
PI157397
PI157451
PI157454
PI157483
PI196170
PI253653B
PI339870
PI339978
PI340009
PI340017
PI340027
PI398311
PI398316
PI398390
PI398581
PI398646
PI398693
PI398952
PI399009
PI399085
PI407790-2
PI407816
PI408021
PI408079B
PI408138A
PI408157
PI408218
PI408308B
PI416771
PI423793
PI423826C
PI423861
PI424173
PI424213
PI424294C
PI424350
PI424351
PI424352
PI424532
PI424549B
PI442019
PI458043
PI458072A
PI458082
PI458094
PI458222
PI458286
PI506657
PI509102
PI594006
PI594010
PI157405
PI157430
PI157436
PI157439
PI157442
PI157446
PI157459
PI157474
PI159923A
PI200447
PI227158
PI398243
PI398507
PI398509
PI398692
PI398969
PI399024
PI399059
PI399067
PI407821A
PI407843
PI407892C
PI407921
PI407946-2
PI407972B
PI408046
PI408071
PI408146
PI408251
PI408272A
PI416837
PI423767
PI423774
PI424368B
PI424410
PI458025
PI458060B
PI458067B
PI458097
PI458146
PI458194
PI458202B
PI458248
PI603160
PI603912
PI479759
PI547094
PI547402
PI547410
PI547428
PI547432
PI547434
PI547480
PI547481
PI547482
PI547511
PI547518
PI547528
PI547530
PI547540
PI547547
PI547549
PI547559
PI547562
PI547569
PI547573
PI547580
PI547586
PI547589
PI547604
PI547609
PI547626
PI547627
PI547631
PI547635
PI547636
PI547638
PI547654
PI547660
PI547796
PI547797
PI547804
PI547814
PI547867
PI548549
PI548586
PI548628
PI548677
PI553041
PI556687
PI556850
PI567782
PI591498
PI591509
PI591520
PI591537
PI597386
PI602449
PI602450
PI634762
PI634881
PI634893
PI634910
PI639562
PI427139
PI475783B
PI542709
PI547419
PI547425
PI547427
PI547436
PI547452
PI547461
PI547467
PI547476
PI547489
PI547508
PI547521
PI547538
PI547545
PI547560
PI547583
PI547598
PI547599
PI547608
PI547618
PI547628
PI547639
PI547640
PI547642
PI547662
PI547845
PI547846
PI547856
PI547872
PI547878
PI547883
PI547887
PI548208
PI548214
PI548281
PI548534
PI548557
PI548598
PI548616
PI548622
PI548636
PI562374
PI584441
PI591484
PI591497
PI591502
PI591510
PI591524
PI591525
PI591531
PI591540
PI597382
PI597478B
PI603571B
PI603742C
PI614154
PI632422
PI634760
PI634827
PI636464
PI371610
PI371611
PI445830
PI476352A
PI507708
PI533601
PI534646
PI534648
PI537095
PI542711
PI547415
PI547437
PI547444
PI547453
PI547479
PI547524
PI547525
PI547535
PI547543
PI547572
PI547576
PI547603
PI547630
PI547644
PI547801
PI547833
PI547862
PI547876
PI548210
PI548231
PI548242
PI548253
PI548259
PI548263
PI548288
PI548520
PI548569
PI548597
PI548611
PI548681
PI556778
PI556928
PI557011
PI567783
PI576166
PI591506
PI591539
PI592936
PI595363
PI603205
PI612738
PI615554
PI632426
PI632427
PI632963
PI634761
PI634903
PI634906
PI81031-1
PI81763
PI85420
PI88816
PI90570
PI91731
PI93055
PI84946-1
PI87059
PI89783
PI82218
PI82315
PI82555
PI83891
PI83946
PI85559
PI84742
PI85550
PI85590
PI85630
PI86978
PI97066
PI81774
PI83944
PI85355
PI85424
PI85469
PI86740
PI90573
PI95960
PI97161
PI70467
FC31918
PI65342
PI80479
PI80831
PI81766
PI82184S
PI82210
PI82286
PI82307
PI82554
PI82581
PI83874
PI83889
PI83923
PI85272
PI87013
PI87561
PI87575
PI88292
PI88788
PI88816S
PI90220
PI90241
PI90563
PI91073
PI91164
PI91679
PI91731-1
PI92743
PI95887
PI96093
PI96550
PI105579
PI157402
PI157421
PI157428
PI157438
PI157441
PI157445
PI157447
PI157449
PI157458
PI157460
PI157462
PI157470
PI157471
PI157472
PI157477
PI165583
PI175183
PI175186
PI175187
PI189939
PI192871
PI196167
PI196168
PI196171
PI196172
PI196175
PI200472
PI200524
PI215688
PI232988
PI232989
PI266807C
PI297543
PI323568
PI323573
PI323575
PI323577
PI339866
PI339980
PI339982
PI340032
PI342002
PI358321A
PI361062A
PI391585
PI398234
PI398263
PI398295
PI398323
PI398330
PI398334
PI398358
PI398413
PI398534
PI398699
PI398722
PI398725
PI398743
PI398779
PI398786
PI398795
PI398799
PI398851
PI398861
PI398915
PI398971
PI398999
PI399005
PI399022
PI399042
PI399048
PI399052
PI399053
PI399065
PI399071
PI399086
PI399096
PI399113
PI399122
PI404166
PI407773A
PI407779
PI407789
PI407813
PI407819
PI407836
PI407839-1
PI407841
PI407844
PI407857
PI407861C
PI407865
PI407922
PI407949
PI407968
PI407972C
PI407976B
PI407987
PI407988A
PI407994
PI407996
PI408000
PI408027
PI408090
PI408131A
PI408134B
PI408159
PI408186A
PI408198
PI408208
PI408221B
PI408293-2
PI416838
PI416839
PI416934
PI416954
PI416960
PI417019
PI417221
PI417229
PI417400
PI423728B
PI423743B
PI423779
PI423783
PI423789
PI423808B
PI423820
PI423825
PI423826A
PI423826B
PI423856
PI424143
PI424144
PI424147
PI424156A
PI424159A
PI424164A
PI424169B
PI424220B
PI424224
PI424240
PI424266
PI424308
PI424321
PI424334
PI424335A
PI424339
PI424342A
PI424353
PI424363
PI424375
PI424416
PI424446
PI424451
PI424454
PI424460
PI424520
PI424535A
PI424543
PI424549A
PI424555B
PI424562
PI424596
PI437366
PI437564
PI437662
PI437690
PI437800
PI437864B
PI437916
PI438031
PI438033
PI438199
PI438223
PI438240
PI438304A
PI438304B
PI438411
PI438456
PI438496A
PI438496B
PI438496C
PI442017
PI458027
PI458046
PI458096
PI458106
PI458110
PI458174
PI458184
PI458217
PI458219
PI458235
PI458236B
PI458244B
PI458264
PI458269
PI458271
PI458293
PI458519A
PI458531
PI468915
PI475818
PI476914
PI481690
PI494182
PI504488
PI504490
PI506420
PI506476
PI506550A
PI506634
PI506868
PI507132A
PI507238
PI507244
PI507325
PI507354
PI507702
PI509076
PI509080
PI509081
PI509096
PI509109
PI510670
PI518291A
PI518670
PI518671
PI518675
PI538401B
PI542043
PI542710
PI543856
PI546487
PI547408
PI547412
PI547413
PI547416
PI547423
PI547424
PI547429
PI547431
PI547438
PI547439
PI547445
PI547447
PI547451
PI547456
PI547463
PI547470
PI547478
PI547490
PI547496
PI547497
PI547498
PI547500
PI547501
PI547503
PI547512
PI547513
PI547515
PI547523
PI547534
PI547536
PI547537
PI547539
PI547541
PI547548
PI547552
PI547554
PI547558
PI547581
PI547584
PI547590
PI547591
PI547594
PI547596
PI547601
PI547602
PI547610
PI547612
PI547614
PI547616
PI547623
PI547624
PI547643
PI547645
PI547646
PI547650
PI547652
PI547653
PI547664
PI547665
PI547807
PI547815
PI547834
PI547836
PI547837
PI547839
PI547840
PI547849
PI547852
PI547857
PI547858
PI547860
PI547861
PI547863
PI547870
PI547871
PI547874
PI547877
PI547879
PI547880
PI547886
PI547888
PI547891
PI547893
PI548193
PI548199
PI548205
PI548209
PI548243
PI548262
PI548265
PI548276
PI548292
PI548313
PI548334
PI548402S
PI548478
PI548509
PI548531
PI548538
PI548541
PI548542
PI548547
PI548566
PI548574
PI548591
PI548594
PI548634
PI548641
PI548679
PI548684
PI548685
PI556780
PI556781
PI556816
PI556889
PI556931
PI557535
PI560207
PI567121A
PI567128B
PI567184
PI567226
PI567234A
PI567491A
PI567517
PI567527
PI567548
PI567569
PI567628B
PI567630A
PI567662
PI567731
PI567767B
PI574541
PI576146
PI577798
PI578306B
PI578307C
PI578318D
PI584470
PI587588A
PI587966B
PI591487
PI591490
PI591491
PI591503
PI591519
PI591522
PI591523
PI591526
PI591527
PI591528
PI591530
PI591561
PI592903
PI593957
PI594005D
PI594008
PI594014B
PI594170B
PI594872
PI595926
PI597387
PI597481
PI603173
PI603332
PI603412B
PI603420
PI603444C
PI603445B
PI603453
PI603454
PI603489
PI603490
PI603491
PI603495B
PI603588
PI603720
PI603733
PI603915D
PI605806A
PI605825C
PI606364
PI606408
PI607380
PI612736
PI614155
PI614807
PI615514
PI615555
PI616498
PI628874
PI632401
PI632405
PI632425
PI632430
PI632945B
PI633608
PI634757
PI634758
PI634763
PI634764
PI634876
PI634895
PI634905
PI634909
PI636695
PI639543
PI639563
PI644024


## Run bcftools to filter samples in my population(listed in lines.txt)
#./bcftools view -S ^lines.txt soysnp50k_wm82.a2_41317.vcf.gz > filtered.vcf  
##Did not run due to errors in file.txt and vcf file


# Fixing the vcf file header and file.txt be removing whitespace (trailing accessions)
#install SAMtools using conda
cd .. 
module load python/3.6-conda5.2
conda create -n SAMtools-env SAMtools
source activate SAMtools-env

## Fixing the vcf file 
tabix -p vcf soysnp50k_wm82.a2_41317.vcf.gz


## Fixing the file.txt by Removing the whitespace
sed -E 's/\s*$//' lines.txt > lines.txt
conda deactivate

# Run bcftools to filter files and convert to PLINK bed files(required by fastStructure)

source activate bcftools-env
bcftools view -S lines.txt soysnp50k_wm82.a2_41317.vcf.gz > filtered.vcf
 
conda deactivate

# create non binary PLINK files
module load vcftools
vcftools --vcf filtered.vcf --plink --out filtered

#Convert to binary files 
module load python/3.6-conda5.2

conda create -y -n plink-env -c bioconda plink
source activate plink-env
plink --file filtered --make-bed --out filtered
conda deactivate

# Install fastStructure from Jelmer's directory 
mkdir faststructure
cp /users/PAS0471/jelmer/software/faststructure/* /fs/ess/PAS1855/users/diaz335/final_project/minus_accessions/faststructure
module load  python/2.7-conda5.2
conda create -y -n faststructure-dep python=2.7 numpy scipy cython=0.27.3
source activate faststructure-dep

cd faststructure
cp /fs/ess/PAS1855/users/diaz335/final_project/my_lines/filtered.* /fs/ess/PAS1855/users/diaz335/final_project/my_lines/faststructure



# Write script to run SLURM for faststructure
nano faststructure.sh 

## write following in script 
#!/bin/bash
#SBATCH --account=PAS1855
#SBATCH --time=22:30:00
#SBATCH --nodes=1
#SBATCH --cpus-per-task=1
#SBATCH --ntasks=1

set -u -e -o pipefail

module load  python/2.7-conda5.2

source activate faststructure-dep
module unload python/2.7-conda5.2


python structure.py -K 1 --input=filtered --output=test1/testoutput_simple --full --seed=100
python structure.py -K 2 --input=filtered --output=test1/testoutput_simple --full --seed=100
python structure.py -K 3 --input=filtered --output=test1/testoutput_simple --full --seed=100
python structure.py -K 4 --input=filtered --output=test1/testoutput_simple --full --seed=100
python structure.py -K 5 --input=filtered --output=test1/testoutput_simple --full --seed=100
python structure.py -K 6 --input=filtered --output=test1/testoutput_simple --full --seed=100
python structure.py -K 7 --input=filtered --output=test1/testoutput_simple --full --seed=100
python structure.py -K 8 --input=filtered --output=test1/testoutput_simple --full --seed=100
python structure.py -K 9 --input=filtered --output=test1/testoutput_simple --full --seed=100
python structure.py -K 10 --input=filtered --output=test1/testoutput_simple --full --seed=100
python structure.py -K 11 --input=filtered --output=test1/testoutput_simple --full --seed=100
python structure.py -K 12 --input=filtered --output=test1/testoutput_simple --full --seed=100
python structure.py -K 13 --input=filtered --output=test1/testoutput_simple --full --seed=100
python structure.py -K 14 --input=filtered --output=test1/testoutput_simple --full --seed=100
python structure.py -K 15 --input=filtered --output=test1/testoutput_simple --full --seed=100
python structure.py -K 16 --input=filtered --output=test1/testoutput_simple --full --seed=100



## Run the script
sbatch faststructure.sh
##checking on progress
squeue -u $USER -l

# fastStructure logistic

nano faststructure_logistic.sh 

## write following in script 
#!/bin/bash
#SBATCH --account=PAS1855
#SBATCH --time=22:30:00
#SBATCH --nodes=1
#SBATCH --cpus-per-task=1
#SBATCH --ntasks=1

set -u -e -o pipefail

module load  python/2.7-conda5.2

source activate faststructure-dep
module unload python/2.7-conda5.2

python structure.py -K 1 --input=filtered --output=test/testoutput_logistic --full --seed=100 --prior=logistic
python structure.py -K 2 --input=filtered --output=test/testoutput_logistic --full --seed=100 --prior=logistic
python structure.py -K 3 --input=filtered --output=test/testoutput_logistic --full --seed=100 --prior=logistic
python structure.py -K 4 --input=filtered --output=test/testoutput_logistic --full --seed=100 --prior=logistic
python structure.py -K 5 --input=filtered --output=test/testoutput_logistic --full --seed=100 --prior=logistic
python structure.py -K 6 --input=filtered --output=test/testoutput_logistic --full --seed=100 --prior=logistic
python structure.py -K 7 --input=filtered --output=test/testoutput_logistic --full --seed=100 --prior=logistic
python structure.py -K 8 --input=filtered --output=test/testoutput_logistic --full --seed=100 --prior=logistic
python structure.py -K 9 --input=filtered --output=test/testoutput_logistic --full --seed=100 --prior=logistic
python structure.py -K 10 --input=filtered --output=test/testoutput_logistic --full --seed=100 --prior=logistic
python structure.py -K 11 --input=filtered --output=test/testoutput_logistic --full --seed=100 --prior=logistic
python structure.py -K 12 --input=filtered --output=test/testoutput_logistic --full --seed=100 --prior=logistic
python structure.py -K 13 --input=filtered --output=test/testoutput_logistic --full --seed=100 --prior=logistic
python structure.py -K 14 --input=filtered --output=test/testoutput_logistic --full --seed=100 --prior=logistic
python structure.py -K 15 --input=filtered --output=test/testoutput_logistic --full --seed=100 --prior=logistic
python structure.py -K 16 --input=filtered --output=test/testoutput_logistic --full --seed=100 --prior=logistic


sbatch faststructure_logistic.sh 
# fastStructure to choose model complexity (model components that explain structure)
python chooseK.py --input=test/testoutput_simple

## after format correction(k=14)
python chooseK.py --input=test/testoutput_simple


# Distruct.py to make plots-visualize results
#matplot 
echo "backend: Agg" > ~/.config/matplotlib/matplotlibrc

## run for K=3
python distruct.py -K 3 --input=test/testoutput_simple --output=test/testoutput_simple_distruct.svg

## run for k=14 (correct one)

python distruct.py -K 14 --input=test/testoutput_simple --output=test/testoutput_simple_distruct.svg